---
- name: Deploy Infrastructure with Helm
  hosts: control_plane
  become: true

  vars:
    kubeconfig: /etc/rancher/k3s/k3s.yaml

  tasks:
    - name: Download Helm install script
      get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        dest: /tmp/get_helm.sh
        mode: '0700'

    - name: Install Helm
      command: /tmp/get_helm.sh
      args:
        creates: /usr/local/bin/helm

    - name: Add Helm repositories
      kubernetes.core.helm_repository:
        name: "{{ item.name }}"
        repo_url: "{{ item.url }}"
      loop:
        - { name: metallb, url: "https://metallb.github.io/metallb" }
        - { name: kubernetes-dashboard, url: "https://kubernetes.github.io/dashboard/" }
        - { name: argo, url: "https://argoproj.github.io/argo-helm" }
        - { name: grafana, url: "https://grafana.github.io/helm-charts" }
        - { name: prometheus-community, url: "https://prometheus-community.github.io/helm-charts" }
        - { name: jetstack, url: "https://charts.jetstack.io" }

    - name: Deploy MetalLB
      kubernetes.core.helm:
        name: metallb
        chart_ref: metallb/metallb
        chart_version: "0.15.2"
        release_namespace: metallb-system
        create_namespace: true
        kubeconfig: "{{ kubeconfig }}"

    - name: Deploy Cert Manager
      kubernetes.core.helm:
        name: cert-manager
        chart_ref: jetstack/cert-manager
        chart_version: "v1.16.2"
        release_namespace: cert-manager
        create_namespace: true
        kubeconfig: "{{ kubeconfig }}"
        values:
          crds:
            enabled: true
          prometheus:
            enabled: true
            servicemonitor:
              enabled: false

    - name: Deploy Kubernetes Dashboard
      kubernetes.core.helm:
        name: kubernetes-dashboard
        chart_ref: kubernetes-dashboard/kubernetes-dashboard
        chart_version: "7.13.0"
        release_namespace: kubernetes-dashboard
        create_namespace: true
        kubeconfig: "{{ kubeconfig }}"

    - name: Deploy ArgoCD
      kubernetes.core.helm:
        name: argocd
        chart_ref: argo/argo-cd
        chart_version: "8.1.3"
        release_namespace: argocd
        create_namespace: true
        kubeconfig: "{{ kubeconfig }}"
        values:
          server:
            insecure: true
            service:
              type: ClusterIP
            metrics:
              enabled: true
              service:
                annotations:
                  prometheus.io/scrape: "true"
                  prometheus.io/port: "8083"
                  prometheus.io/path: "/metrics"
          controller:
            metrics:
              enabled: true
              service:
                annotations:
                  prometheus.io/scrape: "true"
                  prometheus.io/port: "8082"
                  prometheus.io/path: "/metrics"
          repoServer:
            metrics:
              enabled: true
              service:
                annotations:
                  prometheus.io/scrape: "true"
                  prometheus.io/port: "8084"
                  prometheus.io/path: "/metrics"
          configs:
            params:
              server.insecure: true
            cm:
              url: "https://{{ argocd_host }}"
              accounts.image-updater: apiKey
              accounts.image-updater.enabled: "true"
            rbac:
              policy.csv: |
                p, role:image-updater, applications, get, */*, allow
                p, role:image-updater, applications, update, */*, allow
                g, image-updater, role:image-updater

    - name: Deploy ArgoCD Image Updater
      kubernetes.core.helm:
        name: argocd-image-updater
        chart_ref: argo/argocd-image-updater
        chart_version: "0.12.3"
        release_namespace: argocd
        kubeconfig: "{{ kubeconfig }}"
        values:
          config:
            logLevel: info
            argocd:
              grpcWeb: true
              serverAddress: argocd-server.argocd.svc.cluster.local
              insecure: true
              plaintext: false
          extraArgs:
            - --interval
            - 30s
          metrics:
            enabled: true
            service:
              annotations:
                prometheus.io/scrape: "true"
                prometheus.io/port: "8081"
                prometheus.io/path: "/metrics"

    - name: Deploy Loki
      kubernetes.core.helm:
        name: loki
        chart_ref: grafana/loki
        chart_version: "6.32.0"
        release_namespace: monitoring
        create_namespace: true
        kubeconfig: "{{ kubeconfig }}"
        values:
          loki:
            auth_enabled: false
            commonConfig:
              replication_factor: 1
            schemaConfig:
              configs:
                - from: 2024-04-01
                  store: tsdb
                  object_store: s3
                  schema: v13
                  index:
                    prefix: loki_index_
                    period: 24h
            ingester:
              chunk_encoding: snappy
            tracing:
              enabled: true
            pattern_ingester:
              enabled: true
            limits_config:
              allow_structured_metadata: true
              volume_enabled: true
              retention_period: 168h
            compactor:
              retention_enabled: true
              retention_delete_delay: 2h
              delete_request_store: s3
            ruler:
              enable_api: true
            querier:
              max_concurrent: 4
          minio:
            enabled: true
          deploymentMode: SingleBinary
          singleBinary:
            replicas: 1
            resources:
              limits:
                cpu: 500m
                memory: 1Gi
              requests:
                cpu: 200m
                memory: 500Mi
            extraEnv:
              - name: GOMEMLIMIT
                value: 750MiB
          chunksCache:
            writebackSizeLimit: 10MB
            resources:
              limits:
                cpu: 100m
                memory: 200Mi
              requests:
                cpu: 50m
                memory: 100Mi
          resultsCache:
            resources:
              limits:
                cpu: 100m
                memory: 200Mi
              requests:
                cpu: 50m
                memory: 100Mi
          backend:
            replicas: 0
          read:
            replicas: 0
          write:
            replicas: 0
          ingester:
            replicas: 0
          querier:
            replicas: 0
          queryFrontend:
            replicas: 0
          queryScheduler:
            replicas: 0
          distributor:
            replicas: 0
          compactor:
            replicas: 0
          indexGateway:
            replicas: 0
          bloomCompactor:
            replicas: 0
          bloomGateway:
            replicas: 0

    - name: Deploy Prometheus
      kubernetes.core.helm:
        name: prometheus
        chart_ref: prometheus-community/prometheus
        chart_version: "27.28.0"
        release_namespace: monitoring
        kubeconfig: "{{ kubeconfig }}"
        values:
          server:
            persistentVolume:
              enabled: true
              size: 10Gi
            extraArgs:
              web.enable-remote-write-receiver: ""
          alertmanager:
            enabled: false
          kubeStateMetrics:
            enabled: false
          nodeExporter:
            enabled: false
          pushgateway:
            enabled: false
          serverFiles:
            prometheus.yml:
              scrape_configs: []

    - name: Deploy Grafana
      kubernetes.core.helm:
        name: grafana
        chart_ref: grafana/grafana
        chart_version: "9.2.10"
        release_namespace: monitoring
        kubeconfig: "{{ kubeconfig }}"
        values:
          persistence:
            type: pvc
            enabled: true
          service:
            enabled: true
            type: ClusterIP
          initChownData:
            enabled: false
          grafana.ini:
            server:
              root_url: "https://{{ grafana_host }}"
              serve_from_sub_path: false
          datasources:
            datasources.yaml:
              apiVersion: 1
              datasources:
                - name: Loki
                  type: loki
                  access: proxy
                  orgId: 1
                  url: http://loki-gateway.monitoring.svc.cluster.local:80
                  basicAuth: false
                  isDefault: false
                  version: 1
                  editable: false
                - name: Prometheus
                  type: prometheus
                  access: proxy
                  orgId: 1
                  url: http://prometheus-server.monitoring.svc.cluster.local:80
                  basicAuth: false
                  isDefault: true
                  version: 1
                  editable: false

    - name: Deploy k8s-monitoring
      kubernetes.core.helm:
        name: k8s-monitoring
        chart_ref: grafana/k8s-monitoring
        chart_version: "3.1.5"
        release_namespace: monitoring
        kubeconfig: "{{ kubeconfig }}"
        values:
          cluster:
            name: t8s
          global:
            scrapeInterval: 20s
          destinations:
            - name: prometheus
              type: prometheus
              url: http://prometheus-server.monitoring.svc.cluster.local:80/api/v1/write
            - name: loki
              type: loki
              url: http://loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push
          clusterEvents:
            enabled: true
            collector: alloy-logs
          clusterMetrics:
            enabled: true
            collector: alloy-metrics
          podLogs:
            enabled: true
            gatherMethod: kubernetesApi
            collector: alloy-logs
            labelsToKeep:
              - app_kubernetes_io_name
              - container
              - instance
              - job
              - level
              - namespace
              - service_name
              - service_namespace
              - deployment_environment
              - deployment_environment_name
            structuredMetadata:
              pod: pod
          alloy-singleton:
            enabled: true
          alloy-metrics:
            enabled: true
          alloy-logs:
            enabled: true
            alloy:
              mounts:
                varlog: false
                dockercontainers: false
              clustering:
                enabled: true
          alloy-profiles:
            enabled: false
          alloy-receiver:
            enabled: false
          selfReporting:
            enabled: true

    - name: Copy infrastructure chart
      synchronize:
        src: "{{ playbook_dir }}/../infrastructure/"
        dest: "/tmp/t8s-infrastructure/"
        delete: true

    - name: Deploy t8s-infrastructure
      kubernetes.core.helm:
        name: t8s-infrastructure
        chart_ref: /tmp/t8s-infrastructure
        release_namespace: t8s
        create_namespace: true
        kubeconfig: "{{ kubeconfig }}"

    - name: Restart K3s to fix port-forwarding
      systemd:
        name: k3s
        state: restarted

    - name: Wait for K3s to be ready
      command: kubectl get nodes
      register: nodes_check
      until: nodes_check.rc == 0
      retries: 12
      delay: 5
      changed_when: false

    - name: Wait for ArgoCD secret to exist
      command: kubectl -n argocd get secret argocd-initial-admin-secret
      register: argocd_secret_check
      until: argocd_secret_check.rc == 0
      retries: 30
      delay: 10
      changed_when: false

    - name: Wait for Grafana secret to exist
      command: kubectl -n monitoring get secret grafana
      register: grafana_secret_check
      until: grafana_secret_check.rc == 0
      retries: 30
      delay: 10
      changed_when: false

    - name: Wait for Kubernetes Dashboard secret to exist
      command: kubectl -n kubernetes-dashboard get secret admin-user-token
      register: dashboard_secret_check
      until: dashboard_secret_check.rc == 0
      retries: 30
      delay: 10
      changed_when: false

    - name: Retrieve ArgoCD password
      shell: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
      register: argocd_password
      changed_when: false

    - name: Retrieve Grafana password
      shell: kubectl -n monitoring get secret grafana -o jsonpath="{.data.admin-password}" | base64 -d
      register: grafana_password
      changed_when: false

    - name: Retrieve Kubernetes Dashboard token
      shell: kubectl -n kubernetes-dashboard get secret admin-user-token -o jsonpath='{.data.token}' | base64 -d
      register: dashboard_token
      changed_when: false

    - name: Copy image-updater token generation script
      copy:
        src: "{{ playbook_dir }}/../scripts/generate-image-updater-token.sh"
        dest: /tmp/generate-image-updater-token.sh
        mode: '0755'

    - name: Setup ArgoCD Image Updater token and secret
      command: /tmp/generate-image-updater-token.sh
      register: image_updater_result
      changed_when: image_updater_result.rc == 0
      failed_when: image_updater_result.rc not in [0, 10]

    - name: Display credentials
      debug:
        msg:
          - "==========================================="
          - "Cluster Setup Complete!"
          - "==========================================="
          - ""
          - "ArgoCD:"
          - "  URL: https://{{ argocd_host }}"
          - "  Username: admin"
          - "  Password: {{ argocd_password.stdout }}"
          - ""
          - "Grafana:"
          - "  URL: https://{{ grafana_host }}"
          - "  Username: admin"
          - "  Password: {{ grafana_password.stdout }}"
          - ""
          - "Kubernetes Dashboard:"
          - "  URL: https://{{ dashboard_host }}"
          - "  Token: {{ dashboard_token.stdout }}"
          - ""
          - "==========================================="
