---
- name: Configure Infrastructure Secrets and Settings
  hosts: control_plane
  become: true

  vars:
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    cluster_name: "{{ inventory_file | basename | regex_replace('\\.ini$', '') }}"

  tasks:
    - name: Load config
      include_vars:
        file: "{{ playbook_dir }}/../clusters/{{ cluster_name }}.yaml"
        name: config

    - name: Create Longhorn R2 backup secret
      shell: |
        kubectl -n longhorn-system create secret generic longhorn-r2-backups \
          --from-literal=AWS_ACCESS_KEY_ID='{{ config.longhorn.r2.access_key_id }}' \
          --from-literal=AWS_SECRET_ACCESS_KEY='{{ config.longhorn.r2.secret_access_key }}' \
          --from-literal=AWS_ENDPOINTS='https://{{ config.longhorn.r2.account_id }}.r2.cloudflarestorage.com' \
          --dry-run=client -o yaml | kubectl apply -f -
      changed_when: false
      when: config.longhorn.r2.enabled

    # ArgoCD Image Updater Token and Secret Setup
    - name: Copy image-updater token generation script
      copy:
        src: "{{ playbook_dir }}/../scripts/generate-image-updater-token.sh"
        dest: /tmp/generate-image-updater-token.sh
        mode: '0755'

    - name: Setup ArgoCD Image Updater token and secret
      command: /tmp/generate-image-updater-token.sh
      register: image_updater_result
      changed_when: image_updater_result.rc == 0
      failed_when: image_updater_result.rc not in [0, 10]

    # Retrieve and Display Credentials
    - name: Wait for ArgoCD secret to exist
      command: kubectl -n argocd get secret argocd-initial-admin-secret
      register: argocd_secret_check
      until: argocd_secret_check.rc == 0
      retries: 30
      delay: 10
      changed_when: false
      failed_when: false

    - name: Wait for Grafana secret to exist
      command: kubectl -n monitoring get secret grafana
      register: grafana_secret_check
      until: grafana_secret_check.rc == 0
      retries: 30
      delay: 10
      changed_when: false
      failed_when: false

    - name: Wait for Kubernetes Dashboard secret to exist
      command: kubectl -n kubernetes-dashboard get secret admin-user-token
      register: dashboard_secret_check
      until: dashboard_secret_check.rc == 0
      retries: 30
      delay: 10
      changed_when: false
      failed_when: false

    - name: Retrieve ArgoCD password
      shell: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
      register: argocd_password
      changed_when: false
      when: argocd_secret_check.rc == 0

    - name: Retrieve Grafana password
      shell: kubectl -n monitoring get secret grafana -o jsonpath="{.data.admin-password}" | base64 -d
      register: grafana_password
      changed_when: false
      when: grafana_secret_check.rc == 0

    - name: Retrieve Kubernetes Dashboard token
      shell: kubectl -n kubernetes-dashboard get secret admin-user-token -o jsonpath='{.data.token}' | base64 -d
      register: dashboard_token
      changed_when: false
      when: dashboard_secret_check.rc == 0

    - name: Display credentials
      debug:
        msg:
          - "==========================================="
          - "Cluster Credentials"
          - "==========================================="
          - ""
          - "ArgoCD:"
          - "  URL: https://{{ config.hosts.argocd }}"
          - "  Username: admin"
          - "  Password: {{ argocd_password.stdout }}"
          - ""
          - "Grafana:"
          - "  URL: https://{{ config.hosts.grafana }}"
          - "  Username: admin"
          - "  Password: {{ grafana_password.stdout }}"
          - ""
          - "Kubernetes Dashboard:"
          - "  URL: https://{{ config.hosts.dashboard }}"
          - "  Token: {{ dashboard_token.stdout }}"
          - ""
          - "Longhorn:"
          - "  URL: https://{{ config.hosts.longhorn }}"
          - "  Auth: {% if config.longhorn.ingress_and_auth.enabled %}Authentik{% else %}Not enabled{% endif %}"
          - ""
          - "Authentik:"
          - "  URL: https://{{ config.hosts.authentik }}/if/flow/initial-setup/"
          - ""
          - "==========================================="
